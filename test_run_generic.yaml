device_type: DEVICE_TYPE


job_name: " JOB_NAME  @BOARD_TAG  "


tags:
- BOARD_TAG


notify:
    recipients:
    - to:
        method: email
        user: admin
    criteria:
      status: finished
    verbosity: verbose
    compare:
       blacklist: [lava]


timeouts:
  job:
    minutes: 2990
  action:
    minutes: 2990
  connection:
    minutes: 2990
priority: 5
visibility: public


actions:


########
##Flasher Flash from U-Boot
########

- deploy:
    namespace: linux1
    timeout:
      minutes: 40
    to: flasher
    images:
      image:
       # url: file:/lava/edgeq/latestimages/RAPTOR2-GNB-PLFM-B0-raptor2_dev_B0_170823_57/PRODUCT-REL-TITAN-GNB-PLFM-B0-raptor2_dev_B0_170823_57/IMAGES/FIRMWARE/EVB-V2/firmware.bin
        url: file:FIRMWARE_BIN_PATH



#############################
# eMMC boot login after flash
#############################

- boot:
    namespace: linux1
    method: minimal
    auto_login:
      login_prompt: 'login:'
      username: rootrootroot
    timeout:
     minutes: 20
    prompts:
    - 'Password:'
    timeout:
      minutes: 20


#- test:
#    namespace: linux1
#    timeout:
#      minutes: 10
#    interactive:
#    - name: basic_linux_commands_emmcboot
#      prompts: ["login:"]
#      script:
#      - command: root
##        name: basic_linux_commands


#- test:
#    namespace: linux1
#    timeout:
#      minutes: 10
#    interactive:
#    - name: basic_linux_commands_emmcboot
#      prompts: ["# "]
#      script:
#      - command: root
##        name: basic_linux_commands

#- test:
#    namespace: linux1
#    timeout:
#      minutes: 10
#    interactive:
#    - name: basic_linux_commands_emmcboot
#      prompts: ["# "]
#      script:
#      - command: pwd;ls
##        name: basic_linux_commands


- test:
    namespace: linux1
    timeout:
      minutes: 10
    interactive:
    - name: basic_linux_commands_emmcboot
      prompts: ["login:","Password:","# "]
      script:
      - command: root
#        name: basic_linux_commands


- test:
    namespace: linux1
    timeout:
      minutes: 10
    interactive:
    - name: basic_linux_commands_emmcboot
      prompts: ["login:","Password:","# "]
      script:
      - command: root
#        name: basic_linux_commands

- test:
    namespace: linux1
    timeout:
      minutes: 10
    interactive:
    - name: basic_linux_commands_emmcboot
      prompts: ["login:","Password:","# "]
      script:
      - command: root
#        name: basic_linux_commands

- test:
    namespace: linux1
    timeout:
      minutes: 10
    interactive:
    - name: basic_linux_commands_emmcboot
      prompts: ["# "]
      script:
      - command: pwd;ls
#        name: basic_linux_commands




- test:
    namespace: linux1
    timeout:
      minutes: 60
    interactive:
    - name: eMMC_Boot
      prompts: ["# "]
      script:
      #- command: sleep 5;ip link set dev eth0 address 60:E6:F0:D5:9F:1C
      - command: sleep 5;export TFTP_SERVER_IP="TFTP_SERVER_IP_ADDRESS"
      - command: sleep 5;export TFTP_PKG_DIR="TFTP_PKG_DIR_PATH"
      - command: sleep 5;export PACKAGE_VARIANT_NAME="GNB"
      - command: sleep 5;export FIRMWARE_EVB_VER="V2"
      - command: sleep 5;export ETHERNET_PORT="eth0"
      - command: sleep 5;export FW_FLASH_REQ="y"
      - command: sleep 5;cd /opt/flasher/
      - command: sed -i "s|tftp -g -r|set -x;time tftp -g -r|g"  /opt/flasher/emmc_flasher.sh

- test:
    namespace: linux1
    timeout:
      minutes: 60
    interactive:
    - name: eMMC_Boot1
      prompts: ["Restarting system"]
      script:
      - command: echo "y" | sh -v emmc_flasher.sh;
        name: eMMC_Boot
        #successes:
        #- message: "Restarting system"
        #failures:
        #- message: "TIMEOUT"
        #  exception: InfrastructureError
        #  error: "emmc_flasher_script failed"


########
#Linux Boot after flash boot setup
########

- boot:
   namespace: linux1
   method: minimal
   reset: false
   auto_login:
     login_prompt: 'login:'
     username: root
   timeout:
    minutes: 20
   prompts:
   - 'Password:'
   timeout:
     minutes: 20


#- test:
#    namespace: linux1
#    timeout:
#      minutes: 10
#    interactive:
#    - name: basic_linux_commands_emmcboot
#      prompts: ["Login incorrect"]
#      echo: discard
#      script:
#      - command: root
##        name: basic_linux_commands

- test:
   namespace: linux1
   timeout:
     minutes: 10
   interactive:
   - name: basic_linux_commands_emmcboot
     prompts: ["Password:","raptor2 login:","#"]
     echo: discard
     script:
     - command: root
#        name: basic_linux_commands


#- test:
#    namespace: linux1
#    timeout:
#      minutes: 4
#    interactive:
#    - name: basic_linux_commands
#      prompts: ["raptor2 login:","#"]
#      echo: discard
#      script:
#      - command:  root
##        name: lstest
##      - command:

#- test:
#    namespace: linux1
#    timeout:
#      minutes: 4
#    interactive:
#    - name: basic_linux_commands
#      prompts: ["raptor2 login:","#"]
#      echo: discard
#      script:
#      - command:  root

- test:
   namespace: linux1
   timeout:
     minutes: 4
   interactive:
   - name: basic_linux_commands
     prompts: ["# "]
     echo: discard
     script:
#     - command:
     - command: ls -ltr;pwd; df -h; ls -l /dev | grep -i mmc;reboot
#        name: lstest
       successes:
       - message: "total"
       failures:
       - message: "TIMEOUT"
#          exception: InfrastructureError
         error: "ls failed"



#
#linux boot
#
- boot:
   namespace: linux1
   method: minimal
   reset: false
   auto_login:
     login_prompt: 'login:'
     username: rootrootrootrootroot
   timeout:
    minutes: 20
   prompts:
   - 'Password:'
   timeout:
     minutes: 20


- test:
   namespace: linux1
   timeout:
     minutes: 10
   interactive:
   - name: basic_linux_commands_emmcboot
     prompts: ["Login incorrect"]
     script:
     - command: root
#        name: basic_linux_commands

- test:
   namespace: linux1
   timeout:
     minutes: 10
   interactive:
   - name: basic_linux_commands_emmcboot
     prompts: ["Password:","raptor2 login:","#"]
     script:
     - command: root
#        name: basic_linux_commands


- test:
   namespace: linux1
   timeout:
     minutes: 4
   interactive:
   - name: Flash_Boot_basic_linux_commands
     prompts: ["#"]
     script:
     - command:  root
#        name: lstest


- test:
   namespace: linux1
   timeout:
     minutes: 4
   interactive:
   - name: basic_linux_commands
     prompts: ["raptor2 login:","Password","#"]
     echo: discard
     script:
     - command:  root

- test:
   namespace: linux1
   timeout:
     minutes: 4
   interactive:
   - name: basic_linux_commands
     prompts: ["raptor2 login:","Password","#"]
     echo: discard
     script:
     - command:  root;reboot


######
# Linux Functional Testing_OCD flash
#######


- boot:
    namespace: linux1
    method: minimal
    reset: false
    auto_login:
      login_prompt: 'login:'
      username: root
#      password_prompt: "Password:"
#      password: "root"
    timeout:
     minutes: 20
    prompts:
    - 'Password:'
#    - '#'
    timeout:
      minutes: 20


- test:
    namespace: linux1
    timeout:
      minutes: 10
    interactive:
    - name: basic_linux_commands_emmcboot
      prompts: ["Password:","raptor2 login:","#"]
      echo: discard
      script:
      - command: root
#        name: basic_linux_commands


- test:
    namespace: linux1
    timeout:
      minutes: 4
    interactive:
    - name: basic_linux_commands
      prompts: ["# "]
      echo: discard
      script:
      #- command:
      - command: ls -ltr;pwd; df -h; ls -l /dev | grep -i mmc
#        name: lstest
        successes:
        - message: "total"
        failures:
        - message: "TIMEOUT"
#          exception: InfrastructureError
          error: "ls failed"



- test:
    namespace: linux1
    timeout:
      minutes: 4
    interactive:
    - name: Flash_Boot_basic_linux_commands
      prompts: ["# "]
      echo: discard
      script:
      #- command:
      #- command:
      - command: rm -rf ~/.bashrc*;echo "PS1=\"name_TEST> \"" >> ~/.bashrc; cp ~/.bashrc ~/.bashrc_default
      - command: rm -rf /root/name.sh; echo "#!/bin/sh" >> /root/name.sh ; echo "name=\$1" >> /root/name.sh; echo "name=\$1" >> /root/name.sh; chmod 777 /root/name.sh
      - command: echo "sed -i \"s|name|\$name|g\" /root/.bashrc" >> /root/name.sh
      - command: rm -rf /root/success.txt; rm -rf /root/fail.txt
      #- command:
      - command: ls -ltr;pwd
        name: lstest
        successes:
        - message: "total"
        failures:
        - message: "TIMEOUT"
          exception: InfrastructureError
          error: "ls failed"
      - command: rm -rf /root/lava_scripts;set -x; expect -c 'set timeout 120; spawn /bin/scp -r -o UserKnownHostsFile=/dev/null  -o StrictHostKeyChecking=no equser@192.168.9.160:/lava/edgeq/lava_scripts /root; expect  "password"; send  "Password\$2021\r"; expect   "#" ; sleep 10'
      - command: sync
      - command: ls -ltr /root/lava_scripts;sync
    - name: MAC_check_linux_level
      prompts: ["# "]
      echo: discard
      script:
      #- command:
      - command: ifconfig -a ; ifconfig eth0
        name: MAC_check_linux_level
        successes:
        - message: "MACADDRESS_VALUE"
        failures:
        - message: "TIMEOUT"
          #exception: InfrastructureError
          error: "MAC_Check_LinuxLevel failed"
    - name: logdump_folder_check
      prompts: ["# "]
      echo: discard
      script:
      #- command:
      - command: ls / | grep "logdump"
        name: logdump_folder_check
        successes:
        - message: "logdump"
        failures:
        - message: "TIMEOUT"
          #exception: InfrastructureError
          error: "ls failed"
    - name: MAC_check_linux_level
      prompts: ["# "]
      echo: discard
      script:
      #- command:
      - command: ifconfig -a ; ifconfig eth0
        name: MAC_check_linux_level
        successes:
        - message: "MACADDRESS_VALUE"
        failures:
        - message: "TIMEOUT"
          #exception: InfrastructureError
          error: "MAC_Check_LinuxLevel failed"
    - name: Flash_Boot_eth_ping_test
      prompts: ["# "]
      echo: discard
      script:
      #- command:
      - command: echo "SUCCESS" >> /root/success.txt; echo "FAIL" >> /root/fail.txt
      #- command:
      #- command:
      - command: ping 192.168.9.160 -c 10 >> /tmp/ping_test.txt ; cat /tmp/ping_test.txt | grep "10 packets transmitted, 10 received, 0% packet loss" ; if  [ $? == 0 ] ; then cat /root/success.txt;else cat /root/fail.txt; fi
        name: Flash_Boot_eth_ping_test
        successes:
        - message: "SUCCESS"
        failures:
        - message: "FAIL"
          error: "Flash_Boot_eth_ping_test fail"
    - name: Flash_Boot_dmesg_errors
      prompts: ["# "]
      script:
      #- command:
      #- command: echo "SUCCESS" >> /root/success.txt; echo "FAIL" >> /root/fail.txt
      - command: dmesg | grep error | grep -v ARCH_SOC_ID | grep -v -e  "error -110 whilst initialising MMC card" -e "virt-edgeq 3c980000.edgeq_virt_uio.* Failed to find dma-channels"; if  [ $? == 0 ] ; then cat /root/fail.txt;else cat /root/success.txt; fi
        name: dmesg_errors
        successes:
        - message: "SUCCESS"
        failures:
        - message: "FAIL"
          error: "dmesg_error test fail"
    - name: Flash_Boot_dmesg_fail
      prompts: ["# "]
      script:
      #- command: echo "SUCCESS" >> /root/success.txt; echo "FAIL" >> /root/fail.txt
      #- command:
      - command: dmesg | grep -i fail | grep -v kernel.sched | grep -v -e "Parsing zephyr-mem" -e "virt-edgeq 3c980000.edgeq_virt_uio.* Failed to find dma-channels"; if  [ $? == 0 ] ; then cat /root/fail.txt;else cat /root/success.txt; fi
        name: dmesg_fail
        successes:
        - message: "SUCCESS"
        failures:
        - message: "FAIL"
          error: "dmesg_fail test fail"
    #- name: L1_Software_Boot
    #  prompts: ["# "]
    #  script:
    #  - command: echo "L1 Software Boot Success" >> /raptor/success.txt; echo "L1 Software Boot Fail" >> /raptor/fail.txt
    #  - command: cd /raptor;tar -xf  l23sw.tar.gz 2> /dev/null;sync;systemctl start raptor2;sleep 80;cat /tmp/evlog.txt | grep -q "Modem service in RUN state"; if [ $? == 0 ] ; then cat /raptor/success.txt;else cat /raptor/fail.txt; fi
    #    name: L1_Software_Boot
    #    successes:
    #    - message: "L1 Software Boot Success"
    #    failures:
    #    - message: "L1 Software Boot Fail"
    #      #exception: InfrastructureError
    #      error: "L1 Software Boot failed"
    - name: Flash_Boot_dpdk_helloworld_linux
      prompts: ["# "]
      echo: discard
      script:
      #- command:
      - command: echo 1024 > /sys/kernel/mm/hugepages/hugepages-2048kB/nr_hugepages; dpdk-helloworld -l 0-3 -n 4 | grep -c 'hello from core 1\|hello from core 2\|hello from core 3\|hello from core 0' | grep '[4]'; if  [ $? == 0 ] ; then cat /root/success.txt;else cat /root/fail.txt; fi
        name: dpdk_helloworld_linux
        successes:
        - message: "SUCCESS"
        failures:
        - message: "FAIL"
          error: "dpdk hellowrold test fail"
    - name: Flash_Boot_uio17_info
      prompts: ["# "]
      echo: discard
      script:
      #- command:
      - command: cat /sys/class/uio/uio17/name | grep DDRGNBNGPCU ; if  [ $? == 0 ] ; then cat /root/success.txt;else cat /root/fail.txt; fi
        name: uio17_info_name
        successes:
        - message: "SUCCESS"
        failures:
        - message: "FAIL"
          error: "uio17 info test fail"
      #- command:
      - command: cat /sys/class/uio/uio17/maps/map0/addr | grep 0000000900000000 ; if  [ $? == 0 ] ; then cat /root/success.txt;else cat /root/fail.txt; fi
        name: uio17_info_map_address
        successes:
        - message: "SUCCESS"
        failures:
        - message: "FAIL"
          error: "uio17 info test fail"
      #- command:
      - command: cat /sys/class/uio/uio17/maps/map0/size | grep 0000000040000000 ; if  [ $? == 0 ] ; then cat /root/success.txt;else cat /root/fail.txt; fi
        name: uio17_info_name
        successes:
        - message: "SUCCESS"
        failures:
        - message: "FAIL"
          error: "uio17 info test fail"
    - name: Flash_Boot_uio18_info
      prompts: ["# "]
      script:
      #- command:
      - command: cat /sys/class/uio/uio18/name | grep DDRGNBNGPDU ; if  [ $? == 0 ] ; then cat /root/success.txt;else cat /root/fail.txt; fi
        name: uio18_info_name
        successes:
        - message: "SUCCESS"
        failures:
        - message: "FAIL"
          error: "uio18 info test fail"
      #- command:
      - command: cat /sys/class/uio/uio18/maps/map0/addr | grep 0000000940000000 ; if  [ $? == 0 ] ; then cat /root/success.txt;else cat /root/fail.txt; fi
        name: uio18_info_map_address
        successes:
        - message: "SUCCESS"
        failures:
        - message: "FAIL"
          error: "uio18 info test fail"
      #- command:
      - command: cat /sys/class/uio/uio18/maps/map0/size | grep 0000000040000000 ; if  [ $? == 0 ] ; then cat /root/success.txt;else cat /root/fail.txt; fi
        name: uio18_info_name
        successes:
        - message: "SUCCESS"
        failures:
        - message: "FAIL"
          error: "uio18 info test fail"
    #- name: eMMC-Linux
    #  prompts: ["# "]
    #  echo: discard
    #  script:
    #  - command: dmesg | grep -i mmc | grep "MMC card at address" && echo "SUCCESS"
    #    name: eMMC-detection-Linux
    #    successes:
    #    - message: "SUCCESS"
    #    failures:
    #    - message: "FAIL"
    #      error: "eMMC detection at linux level test fail"
    #  - command: "cd /root; echo 'label: dos' >> mmcblk01.sfdisk ; echo 'label-id: 0x02adb288' >> mmcblk01.sfdisk ; echo 'device: /dev/mmcblk0' >> mmcblk01.sfdisk ; echo 'unit: sectors' >> mmcblk01.sfdisk; echo ' ' >> mmcblk01.sfdisk ; echo '/dev/mmcblk0p1 : start=       2048, size=      4194304, type=83' >> mmcblk01.sfdisk"
    #  - command: "cat mmcblk01.sfdisk"
    #  - command: umount /dev/mmcblk0* | echo "y" | sfdisk /dev/mmcblk0 < mmcblk01.sfdisk && echo "SUCCESS"
    #    name: eMMC-partition-table-creation-Linux
    #    successes:
    #    - message: "SUCCESS"
    #    failures:
    #    - message: "FAIL"
    #      error: "eMMC partition table creation at linux level test fail"
    #  - command: echo "y" | mkfs.ext4 /dev/mmcblk0p1 && echo "SUCCESS"
    #    name: eMMC-format-Linux
    #    successes:
    #    - message: "SUCCESS"
    #    failures:
    #    - message: "FAIL"
    #      error: "eMMC format at linux level test fail"
    # - name: Flash_Boot_USB-Linux
      # prompts: ["# "]
      # echo: discard
      # script:
      # #- command:
      # - command: dmesg | grep -i usb | grep "USB .* Storage device detected" ; if  [ $? == 0 ] ; then cat /root/success.txt;else cat /root/fail.txt; fi
        # name: Flash_Boot_USB-detection-Linux
        # successes:
        # - message: "SUCCESS"
        # failures:
        # - message: "FAIL"
          # error: "USB detection at linux level test fail"
      # #- command:
      # - command: cd /root
      # #- command:
      # - command: rm -rf /root/usb.sfdisk
      # #- command:
      # - command: "echo 'label: dos' >> usb.sfdisk ; echo 'label-id: 0x02adb289' >> usb.sfdisk ; echo 'device: /dev/sda' >> usb.sfdisk ; echo 'unit: sectors' >> usb.sfdisk; echo ' ' >> usb.sfdisk ; echo '/dev/sda1 : start=2048, size=4194304, type=83' >> usb.sfdisk "
      # #- command:
      # - command: "cat usb.sfdisk;sync;sleep 5"
      # #- command:
      # - command: umount /dev/sd*
      # #- command:
      # #- command: echo "y" | sfdisk /dev/sda < usb.sfdisk && echo "SUCCESS"
      # - command: echo "y" | sfdisk /dev/sda < usb.sfdisk ; if  [ $? == 0 ] ; then cat /root/success.txt;else cat /root/fail.txt; fi
        # name: Flash_Boot_USB-partition-table-creation-Linux
        # successes:
        # - message: "SUCCESS"
        # failures:
        # - message: "FAIL"
          # error: "USB partition table creation at linux level test fail"
      # #- command:
      # #- command: echo "y" | mkfs.ext4 /dev/sda1 && echo "SUCCESS"
      # - command: echo "y" | mkfs.ext4 /dev/sda1 ; if  [ $? == 0 ] ; then cat /root/success.txt;else cat /root/fail.txt; fi
        # name: Flash_Boot_USB-format-Linux
        # successes:
        # - message: "SUCCESS"
        # failures:
        # - message: "FAIL"
          # error: "USB format at linux level test fail"
      # #- command:
      # - command: dmesg
      # #- command:

- test:
    namespace: linux1
    timeout:
      minutes: 15
      skip: true
    interactive:
    - name: I2C
      prompts: ["# "]
      script:
      - command: i2cdetect -l | grep i2c-2 ; if  [ $? == 0 ] ; then cat /root/success.txt;else cat /root/fail.txt; fi
        name: i2c_detect
        successes:
        - message: "SUCCESS"
        failures:
        - message: "FAIL"
          error: "i2c_detect test fail"

- test:
    namespace: linux1
    timeout:
      minutes: 5
      skip: true
    interactive:
    - name: SSH
      prompts: ["PREEMPT_RT"]
      script:
      - command:  ip="$(ifconfig | grep -A 1 'eth0' | tail -1 | cut -d ':' -f 2 | cut -d ' ' -f 1)"; echo ip=$ip; chmod 777 /root/lava_scripts/ssh_tests.expect; /root/lava_scripts/ssh_tests.expect 192.168.9.160 $ip
        name: ssh_root_login
        successes:
        - message: "running"
        failures:
        - message: "No route to host"
          error: "ssh_root test fail"
    - name: SSH
      prompts: ["# "]
      script:
      - command:
        name: ssh_root_login_1



- test:
    namespace: linux1
    timeout:
      minutes: 30
      skip: true
    interactive:
    - name: perf_LMBench_Performance_Test
      prompts: ["perf_LMBench_Performance_TEST"]
      script:
      #- command:
      - command: set +x;cp ~/.bashrc_default ~/.bashrc;/root/name.sh perf_LMBench_Performance;source ~/.bashrc;cd /lmbench-3.0-a9/;cp configs/CONFIG.raptor2 bin/arm-linux/;cd scripts/;export OS=arm-linux;taskset -c 3 ./results
        name: perf_LMBench
        successes:
        - message: "Calculating memory load latency"
        failures:
        - message: "TIMEOUT"
          exception: InfrastructureError
          error: "LMBench failed"


- test:
    namespace: linux1
    timeout:
      minutes: 10
      skip: true
    interactive:
    - name: perf_LMBench_Performance_output
      prompts: ["perf_LMBench_Performance_output_TEST"]
      script:
      - command: set +x;cp ~/.bashrc_default ~/.bashrc;/root/name.sh perf_LMBench_Performance_output;source ~/.bashrc;cat /lmbench-3.0-a9/results/arm-linux/raptor2.0 >> results.txt; cat results.txt
        name: perf_LMBench-output
        successes:
        - message: "Random load latency"
        failures:
        - message: "TIMEOUT"
          exception: InfrastructureError
          error: "LMBench failed"

- test:
    namespace: linux1
    timeout:
      minutes: 10
      skip: true
    interactive:
    - name: perf_Coremark_mthread_Performance_Test
      prompts: ["perf_Coremark_mthread_Performance_TEST"]
      script:
      - command: set +x;cp ~/.bashrc_default ~/.bashrc;/root/name.sh perf_Coremark_mthread_Performance;source ~/.bashrc;cd /coremark;./coremark_mthread.exe
        name: perf_Coremark_mthread-output
        successes:
        - message: "Correct operation validated"
        failures:
        - message: "TIMEOUT"
          exception: InfrastructureError
          error: "Coremark_mthread test failed"

- test:
    namespace: linux1
    timeout:
      minutes: 10
      skip: true
    interactive:
    - name: perf_Coremark_sthread_Performance_Test
      prompts: ["perf_Coremark_sthread_Performance_TEST"]
      script:
      - command: set +x;cp ~/.bashrc_default ~/.bashrc;/root/name.sh perf_Coremark_sthread_Performance;source ~/.bashrc;cd /coremark;./coremark_sthread.exe
        name: perf_Coremark_sthread-output
        successes:
        - message: "Correct operation validated"
        failures:
        - message: "TIMEOUT"
          exception: InfrastructureError
          error: "Coremark_sthread test failed"


# - test:
    # namespace: linux1
    # timeout:
      # minutes: 2
      # skip: true
    # interactive:
    # - name: perf_Dhrystone_Performance_Test
      # prompts: ["# "]
      # script:
      # - command: cd  /benchmarks/dhrystone2.1; echo 100000000 | ./cc_dry2
        # name: perf_Dhrystone-output
        # successes:
        # - message: "Dhrystones per Second:"
        # failures:
        # - message: "TIMEOUT"
          # exception: InfrastructureError
          # error: "Dhrystone test failed"


- test:
    namespace: linux1
    timeout:
      minutes: 15
      skip: true
    interactive:
    - name: parallel_run_tests
      prompts: ["parallel_run_tests_TEST"]
      script:
      - command: set +x;cp ~/.bashrc_default ~/.bashrc;/root/name.sh parallel_run_tests;source ~/.bashrc
      - command: cd /coremark;./coremark_mthread.exe &
      - command: cd /lmbench-3.0-a9/;cp configs/CONFIG.raptor2 bin/arm-linux/;cd scripts/;export OS=arm-linux;taskset -c 3 ./results &
      #- command: udhcpc; ip="$(ifconfig | grep -A 1 'eth0' | tail -1 | cut -d ':' -f 2 | cut -d ' ' -f 1)"; echo ip=$ip; set -x; mkdir -p /tmp/nfs; mount 192.168.3.230:/lab-nfs /tmp/nfs; cp -r /tmp/nfs/koti/lava_scripts/ /root ; chmod 777 -R /root/lava_scripts;/root/lava_scripts/kill_iperf_arguments.expect 192.168.251.12;/root/lava_scripts/iperf_mtu_setup_server_arguments.expect  192.168.251.12  2000;/root/lava_scripts/run_iperf_arguments.expect 192.168.251.12;iperf3 -c 192.168.251.12 ;/root/lava_scripts/kill_iperf_arguments.expect 192.168.251.12;/root/lava_scripts/iperf_mtu_setup_server_arguments.expect  192.168.251.12  1500 ; sleep 600;
      - command:  ip="$(ifconfig | grep -A 1 'eth0' | tail -1 | cut -d ':' -f 2 | cut -d ' ' -f 1)"; echo ip=$ip; set -x; chmod 777 -R /root/lava_scripts;/root/lava_scripts/kill_iperf_arguments.expect 192.168.8.226;/root/lava_scripts/iperf_mtu_setup_server_arguments.expect  192.168.6.220  2000 enp7s0f1;/root/lava_scripts/run_iperf_arguments.expect 192.168.8.226;iperf3 -c 192.168.6.220 ;/root/lava_scripts/kill_iperf_arguments.expect 192.168.8.226;/root/lava_scripts/iperf_mtu_setup_server_arguments.expect  192.168.6.220  1500 enp7s0f1; sleep 600;
      - command: pwd;df -h
        name: parallel_run_tests


#- test:
#    namespace: linux1
#    timeout:
#      minutes: 30
#      skip: true
#    interactive:
#    - name: DPDK_RX_10G_64
#      #prompts: ["Port 0 is closed "]
#      prompts: ["Bye..."]
#      echo: discard
#      script:
#      #- command: udhcpc;dpdk-hugepages.py -p 32M --setup 512M; ip="$(ifconfig | grep -A 1 'eth0' | tail -1 | cut -d ':' -f 2 | cut -d ' ' -f 1)"; echo ip=$ip; set -x; mkdir -p /tmp/nfs; mount 192.168.3.230:/lab-nfs /tmp/nfs; cp -r /tmp/nfs/koti/lava_scripts/ /root ; chmod 777 -R /root/lava_scripts;cd /root/lava_scripts/dpdk;./dpdk_run.sh  "dpdk-testpmd -l 4-5 -n 4 -d /lib/librte_mempool_ring.so -d /lib/librte_net_raptor2.so --vdev=XGMAC0 -- -i --forward-mode=rxonly" 64;
#      - command: dpdk-hugepages.py -p 32M --setup 512M; ip="$(ifconfig | grep -A 1 'eth0' | tail -1 | cut -d ':' -f 2 | cut -d ' ' -f 1)"; echo ip=$ip; set -x; chmod 777 -R /root/lava_scripts;cd /root/lava_scripts/dpdk;./dpdk_run.sh  "dpdk-testpmd -l 4-5 -n 4 -d /lib/librte_mempool_ring.so -d /lib/librte_net_raptor2.so --vdev=XGMAC0 -- -i --forward-mode=rxonly" 64;
#        name: DPDK_RX_10G_64
#        successes:
#        - message: "Shutting down port 0..."
#        failures:
#        - message: "TIMEOUT"
#          #exception: InfrastructureError
#          error: "dpdk failed"
#    - name: DPDK_RX_10G_512
#      prompts: ["Bye..."]
#      echo: discard
#      script:
#      #- command: udhcpc; ip="$(ifconfig | grep -A 1 'eth0' | tail -1 | cut -d ':' -f 2 | cut -d ' ' -f 1)"; echo ip=$ip; set -x; mkdir -p /tmp/nfs; mount 192.168.3.230:/lab-nfs /tmp/nfs; cp -r /tmp/nfs/koti/lava_scripts/ /root ; chmod 777 -R /root/lava_scripts;cd /root/lava_scripts/dpdk;./dpdk_run.sh  "dpdk-testpmd -l 4-5 -n 4 -d /lib/librte_mempool_ring.so -d /lib/librte_net_raptor2.so --vdev=XGMAC0 -- -i --forward-mode=rxonly" 512;
#      - command:  ip="$(ifconfig | grep -A 1 'eth0' | tail -1 | cut -d ':' -f 2 | cut -d ' ' -f 1)"; echo ip=$ip; set -x; chmod 777 -R /root/lava_scripts;cd /root/lava_scripts/dpdk;./dpdk_run.sh  "dpdk-testpmd -l 4-5 -n 4 -d /lib/librte_mempool_ring.so -d /lib/librte_net_raptor2.so --vdev=XGMAC0 -- -i --forward-mode=rxonly" 512;
#        name: DPDK_RX_10G_512
#        successes:
#        - message: "Shutting down port 0..."
#        failures:
#        - message: "TIMEOUT"
#          #exception: InfrastructureError
#          error: "dpdk failed"
#    - name: DPDK_RX_10G_1500
#      prompts: ["Bye..."]
#      echo: discard
#      script:
#      #- command: udhcpc; ip="$(ifconfig | grep -A 1 'eth0' | tail -1 | cut -d ':' -f 2 | cut -d ' ' -f 1)"; echo ip=$ip; set -x; mkdir -p /tmp/nfs; mount 192.168.3.230:/lab-nfs /tmp/nfs; cp -r /tmp/nfs/koti/lava_scripts/ /root ; chmod 777 -R /root/lava_scripts;cd /root/lava_scripts/dpdk;./dpdk_run.sh  "dpdk-testpmd -l 4-5 -n 4 -d /lib/librte_mempool_ring.so -d /lib/librte_net_raptor2.so --vdev=XGMAC0 -- -i --forward-mode=rxonly" 1500;
#      - command:  ip="$(ifconfig | grep -A 1 'eth0' | tail -1 | cut -d ':' -f 2 | cut -d ' ' -f 1)"; echo ip=$ip; set -x; chmod 777 -R /root/lava_scripts;cd /root/lava_scripts/dpdk;./dpdk_run.sh  "dpdk-testpmd -l 4-5 -n 4 -d /lib/librte_mempool_ring.so -d /lib/librte_net_raptor2.so --vdev=XGMAC0 -- -i --forward-mode=rxonly" 1500;
#        name: DPDK_RX_10G_1500
#        successes:
#        - message: "Shutting down port 0..."
#        failures:
#        - message: "TIMEOUT"
#          #exception: InfrastructureError
#          error: "dpdk failed"
#
#- test:
#    namespace: linux1
#    timeout:
#      minutes: 30
#      skip: true
#    interactive:
#    - name: DPDK_TX_10G_64
#      #prompts: ["Bye..."]
#      prompts: ["Bye..."]
#      echo: discard
#      script:
#      #- command: udhcpc; ip="$(ifconfig | grep -A 1 'eth0' | tail -1 | cut -d ':' -f 2 | cut -d ' ' -f 1)"; echo ip=$ip; set -x; mkdir -p /tmp/nfs; mount 192.168.3.230:/lab-nfs /tmp/nfs; cp -r /tmp/nfs/koti/lava_scripts/ /root ; chmod 777 -R /root/lava_scripts;cd /root/lava_scripts/dpdk;./dpdk_run.sh  "dpdk-testpmd -l 4-5 -n 4 -d /lib/librte_mempool_ring.so -d /lib/librte_net_raptor2.so --vdev=XGMAC0 -- -i --forward-mode=txonly --tx-ip=192.168.251.131,192.168.251.12" 64;
#      - command:  ip="$(ifconfig | grep -A 1 'eth0' | tail -1 | cut -d ':' -f 2 | cut -d ' ' -f 1)"; echo ip=$ip; set -x; chmod 777 -R /root/lava_scripts;cd /root/lava_scripts/dpdk;./dpdk_run.sh  "dpdk-testpmd -l 4-5 -n 4 -d /lib/librte_mempool_ring.so -d /lib/librte_net_raptor2.so --vdev=XGMAC0 -- -i --forward-mode=txonly --tx-ip=192.168.251.131,192.168.251.12" 64;
#        name: DPDK_TX_10G_64
#        successes:
#        - message: "Shutting down port 0..."
#        failures:
#        - message: "TIMEOUT"
#          #exception: InfrastructureError
#          error: "dpdk failed"
#    - name: DPDK_TX_10G_512
#      prompts: ["Bye..."]
#      echo: discard
#      script:
#      #- command: udhcpc; ip="$(ifconfig | grep -A 1 'eth0' | tail -1 | cut -d ':' -f 2 | cut -d ' ' -f 1)"; echo ip=$ip; set -x; mkdir -p /tmp/nfs; mount 192.168.3.230:/lab-nfs /tmp/nfs; cp -r /tmp/nfs/koti/lava_scripts/ /root ; chmod 777 -R /root/lava_scripts;cd /root/lava_scripts/dpdk;./dpdk_run.sh  "dpdk-testpmd -l 4-5 -n 4 -d /lib/librte_mempool_ring.so -d /lib/librte_net_raptor2.so --vdev=XGMAC0 -- -i --forward-mode=txonly --tx-ip=192.168.251.131,192.168.251.12" 512;
#      - command:  sleep 110;ip="$(ifconfig | grep -A 1 'eth0' | tail -1 | cut -d ':' -f 2 | cut -d ' ' -f 1)"; echo ip=$ip; set -x; chmod 777 -R /root/lava_scripts;cd /root/lava_scripts/dpdk;./dpdk_run.sh  "dpdk-testpmd -l 4-5 -n 4 -d /lib/librte_mempool_ring.so -d /lib/librte_net_raptor2.so --vdev=XGMAC0 -- -i --forward-mode=txonly --tx-ip=192.168.251.131,192.168.251.12" 512;
#        name: DPDK_TX_10G_512
#        successes:
#        - message: "Shutting down port 0..."
#        failures:
#        - message: "TIMEOUT"
#          #exception: InfrastructureError
#          error: "dpdk failed"
#    - name: DPDK_TX_10G_1500
#      prompts: ["Bye..."]
#      echo: discard
#      script:
#      #- command: udhcpc; ip="$(ifconfig | grep -A 1 'eth0' | tail -1 | cut -d ':' -f 2 | cut -d ' ' -f 1)"; echo ip=$ip; set -x; mkdir -p /tmp/nfs; mount 192.168.3.230:/lab-nfs /tmp/nfs; cp -r /tmp/nfs/koti/lava_scripts/ /root ; chmod 777 -R /root/lava_scripts;cd /root/lava_scripts/dpdk;./dpdk_run.sh  "dpdk-testpmd -l 4-5 -n 4 -d /lib/librte_mempool_ring.so -d /lib/librte_net_raptor2.so --vdev=XGMAC0 -- -i --forward-mode=txonly --tx-ip=192.168.251.131,192.168.251.12" 1500;
#      - command:  ip="$(ifconfig | grep -A 1 'eth0' | tail -1 | cut -d ':' -f 2 | cut -d ' ' -f 1)"; echo ip=$ip; set -x; chmod 777 -R /root/lava_scripts;cd /root/lava_scripts/dpdk;./dpdk_run.sh  "dpdk-testpmd -l 4-5 -n 4 -d /lib/librte_mempool_ring.so -d /lib/librte_net_raptor2.so --vdev=XGMAC0 -- -i --forward-mode=txonly --tx-ip=192.168.251.131,192.168.251.12" 1500;
#        name: DPDK_TX_10G_1500
#        successes:
#        - message: "Shutting down port 0..."
#        failures:
#        - message: "TIMEOUT"
#          #exception: InfrastructureError
#          error: "dpdk failed"
#
#- test:
#    namespace: linux1
#    timeout:
#      minutes: 30
#      skip: true
#    interactive:
#    - name: DPDK_5TSWAP_FORWARDING_10G_64
#      #prompts: ["Port 0 is closed "]
#      prompts: ["Bye..."]
#      echo: discard
#      script:
#      #- command: udhcpc; ip="$(ifconfig | grep -A 1 'eth0' | tail -1 | cut -d ':' -f 2 | cut -d ' ' -f 1)"; echo ip=$ip; set -x; mkdir -p /tmp/nfs; mount 192.168.3.230:/lab-nfs /tmp/nfs; cp -r /tmp/nfs/koti/lava_scripts/ /root ; chmod 777 -R /root/lava_scripts;cd /root/lava_scripts/dpdk;./dpdk_run.sh  "dpdk-testpmd -l 4-5 -n 4 -d /lib/librte_mempool_ring.so -d /lib/librte_net_raptor2.so --vdev=XGMAC0 -- -i --forward-mode=5tswap" 64;
#      - command:  ip="$(ifconfig | grep -A 1 'eth0' | tail -1 | cut -d ':' -f 2 | cut -d ' ' -f 1)"; echo ip=$ip; set -x; chmod 777 -R /root/lava_scripts;cd /root/lava_scripts/dpdk;./dpdk_run.sh  "dpdk-testpmd -l 4-5 -n 4 -d /lib/librte_mempool_ring.so -d /lib/librte_net_raptor2.so --vdev=XGMAC0 -- -i --forward-mode=5tswap" 64;
#        name: DPDK_5TSWAP_FORWARDING_10G_64
#        successes:
#        - message: "Shutting down port 0..."
#        failures:
#        - message: "TIMEOUT"
#          #exception: InfrastructureError
#          error: "dpdk failed"
#    - name: DPDK_5TSWAP_FORWARDING_10G_512
#      prompts: ["Bye..."]
#      echo: discard
#      script:
#      #- command: udhcpc; ip="$(ifconfig | grep -A 1 'eth0' | tail -1 | cut -d ':' -f 2 | cut -d ' ' -f 1)"; echo ip=$ip; set -x; mkdir -p /tmp/nfs; mount 192.168.3.230:/lab-nfs /tmp/nfs; cp -r /tmp/nfs/koti/lava_scripts/ /root ; chmod 777 -R /root/lava_scripts;cd /root/lava_scripts/dpdk;./dpdk_run.sh  "dpdk-testpmd -l 4-5 -n 4 -d /lib/librte_mempool_ring.so -d /lib/librte_net_raptor2.so --vdev=XGMAC0 -- -i --forward-mode=5tswap" 512;
#      - command:  ip="$(ifconfig | grep -A 1 'eth0' | tail -1 | cut -d ':' -f 2 | cut -d ' ' -f 1)"; echo ip=$ip; set -x;  chmod 777 -R /root/lava_scripts;cd /root/lava_scripts/dpdk;./dpdk_run.sh  "dpdk-testpmd -l 4-5 -n 4 -d /lib/librte_mempool_ring.so -d /lib/librte_net_raptor2.so --vdev=XGMAC0 -- -i --forward-mode=5tswap" 512;
#        name: DPDK_5TSWAP_FORWARDING_10G_512
#        successes:
#        - message: "Shutting down port 0..."
#        failures:
#        - message: "TIMEOUT"
#          #exception: InfrastructureError
#          error: "dpdk failed"
#    - name: DPDK_5TSWAP_FORWARDING_10G_1500
#      prompts: ["Bye..."]
#      echo: discard
#      script:
#      #- command: udhcpc; ip="$(ifconfig | grep -A 1 'eth0' | tail -1 | cut -d ':' -f 2 | cut -d ' ' -f 1)"; echo ip=$ip; set -x; mkdir -p /tmp/nfs; mount 192.168.3.230:/lab-nfs /tmp/nfs; cp -r /tmp/nfs/koti/lava_scripts/ /root ; chmod 777 -R /root/lava_scripts;cd /root/lava_scripts/dpdk;./dpdk_run.sh  "dpdk-testpmd -l 4-5 -n 4 -d /lib/librte_mempool_ring.so -d /lib/librte_net_raptor2.so --vdev=XGMAC0 -- -i --forward-mode=5tswap" 1500;
#      - command:  ip="$(ifconfig | grep -A 1 'eth0' | tail -1 | cut -d ':' -f 2 | cut -d ' ' -f 1)"; echo ip=$ip; set -x; chmod 777 -R /root/lava_scripts;cd /root/lava_scripts/dpdk;./dpdk_run.sh  "dpdk-testpmd -l 4-5 -n 4 -d /lib/librte_mempool_ring.so -d /lib/librte_net_raptor2.so --vdev=XGMAC0 -- -i --forward-mode=5tswap" 1500;
#        name: DPDK_5TSWAP_FORWARDING_10G_1500
#        successes:
#        - message: "Shutting down port 0..."
#        failures:
#        - message: "TIMEOUT"
#          #exception: InfrastructureError
#          error: "dpdk failed"



# ###############
# ###Flash firmware from U-Boot
# ################

- boot:
    namespace: linux1
    method: bootloader
    bootloader: u-boot
    commands:
    - ' pri ethaddr'
    prompts:
    - '=>'
    #echo: discard
    timeout:
     minutes: 20



- test:
    namespace: linux1
    timeout:
      minutes: 4
    interactive:
    - name: FirmwareFlash
      prompts: ["=>"]
      echo: discard
      script:
      #- command:
      - command: version
        name: U-Boot_version
      #- command:
      - command: version
        name: FirmwareFlash
        successes:
        - message: "Boot"
        failures:
        - message: "TIMEOUT"
#          exception: InfrastructureError
          error: "Firmware Flash failed"


- test:
    namespace: linux1
    timeout:
      minutes: 20
    interactive:
    - name: FlasherImage_Flash_from_uboot
      prompts: ["=>"]
      echo: discard
      script:
      #- command:
      - command: setenv serverip TFTP_SERVER_IP_ADDRESS
      #- command:
      - command: setenv ipaddr 192.168.6.214; dhcp
      #- command:
      - command: setenv firmware_addr_f 0
      #- command:
      #- command:
      #- command:
      - command: tftp 0x802000000 TFTP_PKG_DIR_PATH/16M.bin
      #- command: tftp 0x802000000 koti/RAPTOR2-GNB-PLFM-B0-raptor2_dev_B0_170823_57/PRODUCT-REL-TITAN-GNB-PLFM-B0-raptor2_dev_B0_170823_57/flash_image_16M.bin
      #- command: tftp 0x402000000 koti/RAPTOR2-GNB-PLFM-B0-raptor2_dev_B0_170823_57/PRODUCT-REL-TITAN-GNB-PLFM-B0-raptor2_dev_B0_170823_57/FLASHER/flash_image_16M.bin
        name: TFTP_Flasher_Image
        successes:
        - message: "done"
        failures:
        - message: "TFTP error"
          error: "Flasher image TFTP failed"
      #- command:
      - command: sleep 20
      #- command:
      - command: sf probe;sf update 0x802000000 0x0 ${filesize}
        name: Flash_Flahserimage_from_uboot
        successes:
        - message: "speed"
        failures:
        - message: "TIMEOUT"
          error: "Firmware Flash failed"
      #- command:
      - command: pri
      #- command:
      - command: sleep 5
      #- command:
#      - command:


#############################
# eMMC boot login after flash
#############################

# - boot:
    # namespace: linux1
    # method: minimal
    # auto_login:
      # login_prompt: 'login:'
      # username: rootrootroot
    # timeout:
     # minutes: 20
    # prompts:
    # - 'Password:'
    # timeout:
      # minutes: 20


# - test:
    # namespace: linux1
    # timeout:
      # minutes: 10
    # interactive:
    # - name: basic_linux_commands_emmcboot
      # prompts: ["login:"]
      # script:
      # - command: root
# #        name: basic_linux_commands


# - test:
    # namespace: linux1
    # timeout:
      # minutes: 10
    # interactive:
    # - name: basic_linux_commands_emmcboot
      # prompts: ["# "]
      # script:
      # - command: root
# #        name: basic_linux_commands

- boot:
    namespace: linux1
    method: minimal
    auto_login:
      login_prompt: 'login:'
      username: rootrootroot
    timeout:
     minutes: 20
    prompts:
    - 'Password:'
    timeout:
      minutes: 20

- test:
    namespace: linux1
    timeout:
      minutes: 10
    interactive:
    - name: basic_linux_commands_emmcboot
      prompts: ["login:","Password:","# "]
      script:
      - command: root
#        name: basic_linux_commands


- test:
    namespace: linux1
    timeout:
      minutes: 10
    interactive:
    - name: basic_linux_commands_emmcboot
      prompts: ["login:","Password:","# "]
      script:
      - command: root
#        name: basic_linux_commands

- test:
    namespace: linux1
    timeout:
      minutes: 10
    interactive:
    - name: basic_linux_commands_emmcboot
      prompts: ["login:","Password:","# "]
      script:
      - command: root
#        name: basic_linux_commands

- test:
    namespace: linux1
    timeout:
      minutes: 10
    interactive:
    - name: basic_linux_commands_emmcboot
      prompts: ["# "]
      script:
      - command: pwd;ls
#        name: basic_linux_commands



- test:
    namespace: linux1
    timeout:
      minutes: 60
    interactive:
    - name: eMMC_Boot
      prompts: ["# "]
      script:
      #- command: sleep 5;ip link set dev eth0 address 60:E6:F0:D5:9F:1C
      - command: sleep 5;export TFTP_SERVER_IP="TFTP_SERVER_IP_ADDRESS"
      - command: sleep 5;export TFTP_PKG_DIR="TFTP_PKG_DIR_PATH"
      - command: sleep 5;export PACKAGE_VARIANT_NAME="GNB"
      - command: sleep 5;export FIRMWARE_EVB_VER="V2"
      - command: sleep 5;export ETHERNET_PORT="eth0"
      - command: sleep 5;export FW_FLASH_REQ="y"
      - command: sleep 5;cd /opt/flasher/
      - command: sed -i "s|tftp -g -r|set -x;time tftp -g -r|g"  /opt/flasher/emmc_flasher.sh

- test:
    namespace: linux1
    timeout:
      minutes: 60
    interactive:
    - name: eMMC_Boot1
      prompts: ["Restarting system"]
      script:
      - command: echo "y" | sh -v emmc_flasher.sh;
        name: eMMC_Boot
        #successes:
        #- message: "Restarting system"
        #failures:
        #- message: "TIMEOUT"
        #  exception: InfrastructureError
        #  error: "emmc_flasher_script failed"


########
#Linux Boot after flash boot setup
########

- boot:
    namespace: linux1
    method: minimal
    reset: false
    auto_login:
      login_prompt: 'login:'
      username: root
    timeout:
     minutes: 20
    prompts:
    - 'Password:'
    timeout:
      minutes: 20


#- test:
#    namespace: linux1
#    timeout:
#      minutes: 10
#    interactive:
#    - name: basic_linux_commands_emmcboot
#      prompts: ["Login incorrect"]
#      echo: discard
#      script:
#      - command: root
##        name: basic_linux_commands

- test:
    namespace: linux1
    timeout:
      minutes: 10
    interactive:
    - name: basic_linux_commands_emmcboot
      prompts: ["Password:","raptor2 login:","#"]
      echo: discard
      script:
      - command: root
#        name: basic_linux_commands


#- test:
#    namespace: linux1
#    timeout:
#      minutes: 4
#    interactive:
#    - name: basic_linux_commands
#      prompts: ["raptor2 login:","#"]
#      echo: discard
#      script:
#      - command:  root
##        name: lstest
##      - command:

#- test:
#    namespace: linux1
#    timeout:
#      minutes: 4
#    interactive:
#    - name: basic_linux_commands
#      prompts: ["raptor2 login:","#"]
#      echo: discard
#      script:
#      - command:  root

- test:
    namespace: linux1
    timeout:
      minutes: 4
    interactive:
    - name: basic_linux_commands
      prompts: ["# "]
      echo: discard
      script:
      #- command:
      - command: ls -ltr;pwd; df -h; ls -l /dev | grep -i mmc;reboot
#        name: lstest
        successes:
        - message: "total"
        failures:
        - message: "TIMEOUT"
#          exception: InfrastructureError
          error: "ls failed"


##
#linux boot
##
- boot:
    namespace: linux1
    method: minimal
    reset: false
    auto_login:
      login_prompt: 'login:'
      username: root
    timeout:
     minutes: 20
    prompts:
    - 'Password:'
    timeout:
      minutes: 20


- test:
    namespace: linux1
    timeout:
      minutes: 10
    interactive:
    - name: basic_linux_commands_emmcboot
      prompts: ["Password:","raptor2 login:","#"]
      echo: discard
      script:
      - command: root
#        name: basic_linux_commands


- test:
    namespace: linux1
    timeout:
      minutes: 4
    interactive:
    - name: basic_linux_commands
      prompts: ["# "]
      echo: discard
      script:
      #- command:
      - command: ls -ltr;pwd; df -h; ls -l /dev | grep -i mmc
#        name: lstest
        successes:
        - message: "total"
        failures:
        - message: "TIMEOUT"
#          exception: InfrastructureError
          error: "ls failed"

- test:
    namespace: linux1
    timeout:
      minutes: 4
    interactive:
    - name: Flash_Boot_basic_linux_commands
      prompts: ["# "]
      echo: discard
      script:
      #- command:
      #- command:
      - command: rm -rf /root/success.txt; rm -rf /root/fail.txt
      #- command:
      - command: ls -ltr;pwd
        name: lstest
        successes:
        - message: "total"
        failures:
        - message: "TIMEOUT"
          exception: InfrastructureError
          error: "ls failed"
    - name: MAC_check_linux_level
      prompts: ["# "]
      echo: discard
      script:
      #- command:
      - command: ifconfig -a ; ifconfig eth0
        name: MAC_check_linux_level
        successes:
        - message: "MACADDRESS_VALUE"
        failures:
        - message: "TIMEOUT"
          #exception: InfrastructureError
          error: "MAC_Check_LinuxLevel failed"
    - name: logdump_folder_check
      prompts: ["# "]
      echo: discard
      script:
      #- command:
      - command: ls / | grep "logdump"
        name: logdump_folder_check
        successes:
        - message: "logdump"
        failures:
        - message: "TIMEOUT"
          #exception: InfrastructureError
          error: "ls failed"
    - name: MAC_check_linux_level
      prompts: ["# "]
      echo: discard
      script:
      #- command:
      - command: ifconfig -a ; ifconfig eth0
        name: MAC_check_linux_level
        successes:
        - message: "MACADDRESS_VALUE"
        failures:
        - message: "TIMEOUT"
          #exception: InfrastructureError
          error: "MAC_Check_LinuxLevel failed"
    - name: Flash_Boot_eth_ping_test
      prompts: ["# "]
      echo: discard
      script:
      #- command:
      - command: echo "SUCCESS" >> /root/success.txt; echo "FAIL" >> /root/fail.txt
      #- command:
      #- command:
      - command: ping 192.168.9.160 -c 10 >> /tmp/ping_test.txt ; cat /tmp/ping_test.txt | grep "10 packets transmitted, 10 received, 0% packet loss" ; if  [ $? == 0 ] ; then cat /root/success.txt;else cat /root/fail.txt; fi
        name: Flash_Boot_eth_ping_test
        successes:
        - message: "SUCCESS"
        failures:
        - message: "FAIL"
          error: "Flash_Boot_eth_ping_test fail"
    - name: Flash_Boot_dmesg_errors
      prompts: ["# "]
      script:
      #- command:
      #- command: echo "SUCCESS" >> /root/success.txt; echo "FAIL" >> /root/fail.txt
      - command: dmesg | grep error | grep -v ARCH_SOC_ID | grep -v -e  "error -110 whilst initialising MMC card" -e "virt-edgeq 3c980000.edgeq_virt_uio.* Failed to find dma-channels" ;if  [ $? == 0 ] ; then cat /root/fail.txt;else cat /root/success.txt; fi
        name: dmesg_errors
        successes:
        - message: "SUCCESS"
        failures:
        - message: "FAIL"
          error: "dmesg_error test fail"
    - name: Flash_Boot_dmesg_fail
      prompts: ["# "]
      script:
      #- command: echo "SUCCESS" >> /root/success.txt; echo "FAIL" >> /root/fail.txt
      #- command:
      - command: dmesg | grep -i fail | grep -v kernel.sched | grep -v -e "Parsing zephyr-mem" -e "virt-edgeq 3c980000.edgeq_virt_uio.* Failed to find dma-channels"; if  [ $? == 0 ] ; then cat /root/fail.txt;else cat /root/success.txt; fi
        name: dmesg_fail
        successes:
        - message: "SUCCESS"
        failures:
        - message: "FAIL"
          error: "dmesg_fail test fail"
    #- name: L1_Software_Boot
    #  prompts: ["# "]
    #  script:
    #  - command: echo "L1 Software Boot Success" >> /raptor/success.txt; echo "L1 Software Boot Fail" >> /raptor/fail.txt
    #  - command: cd /raptor;tar -xf  l23sw.tar.gz 2> /dev/null;sync;systemctl start raptor2;sleep 80;cat /tmp/evlog.txt | grep -q "Modem service in RUN state"; if [ $? == 0 ] ; then cat /raptor/success.txt;else cat /raptor/fail.txt; fi
    #    name: L1_Software_Boot
    #    successes:
    #    - message: "L1 Software Boot Success"
    #    failures:
    #    - message: "L1 Software Boot Fail"
    #      #exception: InfrastructureError
    #      error: "L1 Software Boot failed"
    - name: Flash_Boot_dpdk_helloworld_linux
      prompts: ["# "]
      echo: discard
      script:
      #- command:
      - command: echo 1024 > /sys/kernel/mm/hugepages/hugepages-2048kB/nr_hugepages; dpdk-helloworld -l 0-3 -n 4 | grep -c 'hello from core 1\|hello from core 2\|hello from core 3\|hello from core 0' | grep '[4]'; if  [ $? == 0 ] ; then cat /root/success.txt;else cat /root/fail.txt; fi
        name: dpdk_helloworld_linux
        successes:
        - message: "SUCCESS"
        failures:
        - message: "FAIL"
          error: "dpdk hellowrold test fail"
    - name: Flash_Boot_uio17_info
      prompts: ["# "]
      echo: discard
      script:
      #- command:
      - command: cat /sys/class/uio/uio17/name | grep DDRGNBNGPCU ; if  [ $? == 0 ] ; then cat /root/success.txt;else cat /root/fail.txt; fi
        name: uio17_info_name
        successes:
        - message: "SUCCESS"
        failures:
        - message: "FAIL"
          error: "uio17 info test fail"
      #- command:
      - command: cat /sys/class/uio/uio17/maps/map0/addr | grep 0000000900000000 ; if  [ $? == 0 ] ; then cat /root/success.txt;else cat /root/fail.txt; fi
        name: uio17_info_map_address
        successes:
        - message: "SUCCESS"
        failures:
        - message: "FAIL"
          error: "uio17 info test fail"
      #- command:
      - command: cat /sys/class/uio/uio17/maps/map0/size | grep 0000000040000000 ; if  [ $? == 0 ] ; then cat /root/success.txt;else cat /root/fail.txt; fi
        name: uio17_info_name
        successes:
        - message: "SUCCESS"
        failures:
        - message: "FAIL"
          error: "uio17 info test fail"
    - name: Flash_Boot_uio18_info
      prompts: ["# "]
      script:
      #- command:
      - command: cat /sys/class/uio/uio18/name | grep DDRGNBNGPDU ; if  [ $? == 0 ] ; then cat /root/success.txt;else cat /root/fail.txt; fi
        name: uio18_info_name
        successes:
        - message: "SUCCESS"
        failures:
        - message: "FAIL"
          error: "uio18 info test fail"
      #- command:
      - command: cat /sys/class/uio/uio18/maps/map0/addr | grep 0000000940000000 ; if  [ $? == 0 ] ; then cat /root/success.txt;else cat /root/fail.txt; fi
        name: uio18_info_map_address
        successes:
        - message: "SUCCESS"
        failures:
        - message: "FAIL"
          error: "uio18 info test fail"
      #- command:
      - command: cat /sys/class/uio/uio18/maps/map0/size | grep 0000000040000000 ; if  [ $? == 0 ] ; then cat /root/success.txt;else cat /root/fail.txt; fi
        name: uio18_info_name
        successes:
        - message: "SUCCESS"
        failures:
        - message: "FAIL"
          error: "uio18 info test fail"
    #- name: eMMC-Linux
    #  prompts: ["# "]
    #  echo: discard
    #  script:
    #  - command: dmesg | grep -i mmc | grep "MMC card at address" && echo "SUCCESS"
    #    name: eMMC-detection-Linux
    #    successes:
    #    - message: "SUCCESS"
    #    failures:
    #    - message: "FAIL"
    #      error: "eMMC detection at linux level test fail"
    #  - command: "cd /root; echo 'label: dos' >> mmcblk01.sfdisk ; echo 'label-id: 0x02adb288' >> mmcblk01.sfdisk ; echo 'device: /dev/mmcblk0' >> mmcblk01.sfdisk ; echo 'unit: sectors' >> mmcblk01.sfdisk; echo ' ' >> mmcblk01.sfdisk ; echo '/dev/mmcblk0p1 : start=       2048, size=      4194304, type=83' >> mmcblk01.sfdisk"
    #  - command: "cat mmcblk01.sfdisk"
    #  - command: umount /dev/mmcblk0* | echo "y" | sfdisk /dev/mmcblk0 < mmcblk01.sfdisk && echo "SUCCESS"
    #    name: eMMC-partition-table-creation-Linux
    #    successes:
    #    - message: "SUCCESS"
    #    failures:
    #    - message: "FAIL"
    #      error: "eMMC partition table creation at linux level test fail"
    #  - command: echo "y" | mkfs.ext4 /dev/mmcblk0p1 && echo "SUCCESS"
    #    name: eMMC-format-Linux
    #    successes:
    #    - message: "SUCCESS"
    #    failures:
    #    - message: "FAIL"
    #      error: "eMMC format at linux level test fail"
    - name: Flash_Boot_USB-Linux
      prompts: ["# "]
      echo: discard
      script:
      #- command:
      - command: dmesg | grep -i usb | grep "USB .* Storage device detected" ; if  [ $? == 0 ] ; then cat /root/success.txt;else cat /root/fail.txt; fi
        name: Flash_Boot_USB-detection-Linux
        successes:
        - message: "SUCCESS"
        failures:
        - message: "FAIL"
          error: "USB detection at linux level test fail"
      #- command:
      - command: cd /root
      #- command:
      - command: rm -rf /root/usb.sfdisk
      #- command:
      - command: "echo 'label: dos' >> usb.sfdisk ; echo 'label-id: 0x02adb289' >> usb.sfdisk ; echo 'device: /dev/sda' >> usb.sfdisk ; echo 'unit: sectors' >> usb.sfdisk; echo ' ' >> usb.sfdisk ; echo '/dev/sda1 : start=2048, size=4194304, type=83' >> usb.sfdisk "
      #- command:
      - command: "cat usb.sfdisk;sync;sleep 5"
      #- command:
      - command: umount /dev/sd*
      #- command:
      #- command: echo "y" | sfdisk /dev/sda < usb.sfdisk && echo "SUCCESS"
      - command: echo "y" | sfdisk /dev/sda < usb.sfdisk ; if  [ $? == 0 ] ; then cat /root/success.txt;else cat /root/fail.txt; fi
        name: Flash_Boot_USB-partition-table-creation-Linux
        successes:
        - message: "SUCCESS"
        failures:
        - message: "FAIL"
          error: "USB partition table creation at linux level test fail"
      #- command:
      #- command: echo "y" | mkfs.ext4 /dev/sda1 && echo "SUCCESS"
      - command: echo "y" | mkfs.ext4 /dev/sda1 ; if  [ $? == 0 ] ; then cat /root/success.txt;else cat /root/fail.txt; fi
        name: Flash_Boot_USB-format-Linux
        successes:
        - message: "SUCCESS"
        failures:
        - message: "FAIL"
          error: "USB format at linux level test fail"
      #- command:
      - command: dmesg
      #- command:





##############
##############
###DDR Base boot tests
#################
##########################
####Edgeq-raptor2 linux, Zephyr and linux+Zephyr boot test -RAPTOR2-GNB-PLFM-B0-raptor2_dev_B0_170823_57
#########################


# - deploy:
    # namespace: linux1
    # timeout:
      # minutes: 10
    # to: flasher
    # images:
      # image:
        # url: file:/lava/edgeq/latestimages/RAPTOR2-GNB-PLFM-B0-raptor2_dev_B0_170823_57/PRODUCT-REL-TITAN-GNB-PLFM-B0-raptor2_dev_B0_170823_57/IMAGES/FIRMWARE/EVB-V2/firmware.bin

- boot:
    namespace: linux1
    method: bootloader
    bootloader: u-boot
    commands:
    - ' print'
    prompts:
    - '=>'
    timeout:
      minutes: 3

- test:
    namespace: linux1
    timeout:
      minutes: 4
    interactive:
    - name: FirmwareFlash
      prompts: ["=>"]
      script:
      #- command:
      - command: version;pri ethaddr
        name: U-Boot_version
      #- command:
      - command: version;pri ethaddr
        name: FirmwareFlash
        successes:
        - message: "Boot"
        failures:
        - message: "TIMEOUT"
#          exception: InfrastructureError
          error: "Firmware Flash failed"
      #- command:
      - command: print ethaddr
        name: Board_MAC_Address
        successes:
        - message: "MAC_LOWER_ADDRESS"
        failures:
        - message: "TIMEOUT"
#          exception: InfrastructureError
          error: "Firmware Flash failed"



#######################
##Edgeq-raptor2 U-Boot eMMC scenarios -RAPTOR2-GNB-PLFM-B0-raptor2_dev_B0_170823_57
#######################
#timeouts:
#  job:
#    minutes: 50
#  action:
#    minutes: 50
#  connection:
#    minutes: 50
#priority: 1
#visibility: public

#actions:
- boot:
    namespace: linux1
    method: bootloader
    bootloader: u-boot
    commands:
    - 'print ethaddr;setenv complete "TestComplete" '
    prompts:
    - '=> '
    timeout:
      minutes: 3


- test:
    namespace: linux1
    timeout:
      minutes: 15
      skip: true
    interactive:
    - name: U-boot-ethaddr
#      prompts: ["=> "]
      prompts: ["TestComplete"]
      echo: discard
      script:
      #- command:
      - name: U-Boot-ethaddr
        command: pri ethaddr;print complete
      #- name: wait-for-the-prompt
      #  command:
      #- name: wait-for-the-prompt
      #  command:
      ##- name: wait-for-the-prompt
      ##  command:


- test:
    namespace: linux1
    timeout:
      minutes: 15
      skip: true
    interactive:
    - name: u-boot-eMMC-tests-mtest
      prompts: ["TestComplete"]
      echo: discard
      script:
      #- name: wait-for-the-prompt
      #  command:
      #  successes:
      #  - message: "TestComplete"
      #  failures:
      #  - message: "TIMEOUT"
      #    error: "U-boot eMMC mtest command failed"
      - name: u-boot-eMMC-tests-mtest
        command: mtest 0x810000000 0x8e0000000 0xa5a5dead 1;print complete
        successes:
        - message: "with 0 errors"
        failures:
        - message: "TIMEOUT"
          error: "U-boot eMMC mtest command failed"
        #command:

- test:
    namespace: linux1
    timeout:
      minutes: 15
      skip: true
    interactive:
    - name: u-boot-eMMC-tests-3GB-write
      prompts: ["TestComplete"]
      echo: discard
      script:
      - name: U-Boot_eMMC_3_5GB_datawrite_from_256MB_offset
        #command:
        command: mmc write 0x810000000 0 700000;print complete
        successes:
        - message: "blocks written: OK"
        failures:
        - message: "blocks written: ERROR"
          error: "U-boot eMMMC 3.5GB data write failed"
        #command:

- test:
    namespace: linux1
    timeout:
      minutes: 15
      skip: true
    interactive:
    - name: U-Boot_eMMC_3_5GB_dataread_on_4GB_offset_read
      prompts: ["TestComplete"]
      echo: discard
      script:
      - name: U-Boot_eMMC_3_5GB_dataread_on_4GB_offset
        #command:
        command: mmc read 0x900000000 0 700000;print complete
        successes:
        - message: "blocks read: OK"
        failures:
        - message: "blocks read: ERROR"
          error: "U-boot eMMC 3.5GB data read failed"
        #command:

- test:
    namespace: linux1
    timeout:
      minutes: 15
      skip: true
    interactive:
    - name: U-Boot_eMMC_compare_3_5GB_data_compare
      prompts: ["TestComplete"]
      echo: discard
      script:
      - name: U-Boot_eMMC_compare_3_5GB_data
        #command:
        command: cmp.b 0x810000000 0x900000000 0xe0000000;print complete
        successes:
        - message: "3758096384 byte"
        failures:
        - message: "Total of 0 byte"
          error: "U-boot eMMC 3.5GB data read failed"
        #command:







####Flash the firmware
################
####Flash firmware from U-Boot
#################

- boot:
    namespace: linux1
    method: bootloader
    bootloader: u-boot
    commands:
    - ' pri ethaddr'
    prompts:
    - '=>'
    timeout:
     minutes: 20



- test:
    namespace: linux1
    timeout:
      minutes: 4
    interactive:
    - name: FirmwareFlash
      prompts: ["=>"]
      script:
      - command: version
        name: U-Boot_version
      - command: version
        name: FirmwareFlash
        successes:
        - message: "Boot"
        failures:
        - message: "TIMEOUT"
#          exception: InfrastructureError
          error: "Firmware Flash failed"


- test:
    namespace: linux1
    timeout:
      minutes: 20
    interactive:
    - name: FlasherImage_Flash_from_uboot
      prompts: ["=>"]
      script:
      - command:
      - command: setenv serverip TFTP_SERVER_IP_ADDRESS
      - command: setenv ipaddr 192.168.6.214; dhcp
      - command: setenv firmware_addr_f 0
      - command: tftp 0x802000000 TFTP_PKG_DIR_PATH/16M.bin
      #- command: tftp 0x802000000 koti/RAPTOR2-GNB-PLFM-B0-raptor2_dev_B0_170823_57/PRODUCT-REL-TITAN-GNB-PLFM-B0-raptor2_dev_B0_170823_57/flash_image_16M.bin
      #- command: tftp 0x402000000 koti/RAPTOR2-GNB-PLFM-B0-raptor2_dev_B0_170823_57/PRODUCT-REL-TITAN-GNB-PLFM-B0-raptor2_dev_B0_170823_57/FLASHER/flash_image_16M.bin
        name: TFTP_Flasher_Image
        successes:
        - message: "done"
        failures:
        - message: "TFTP error"
          error: "Flasher image TFTP failed"
      - command: sleep 20
      - command: sf probe;sf update 0x802000000 0x0 ${filesize}
        name: Flash_Flahserimage_from_uboot
        successes:
        - message: "speed"
        failures:
        - message: "TIMEOUT"
          error: "Firmware Flash failed"
      - command: pri
      - command: sleep 5
#      - command:


#############################
# eMMC boot login after flash
#############################

- boot:
    namespace: linux1
    method: minimal
    auto_login:
      login_prompt: 'login:'
      username: rootrootroot
    timeout:
     minutes: 20
    prompts:
    - 'Password:'
    timeout:
      minutes: 20


- test:
    namespace: linux1
    timeout:
      minutes: 10
    interactive:
    - name: basic_linux_commands_emmcboot
      prompts: ["login:","Password:","# "]
      script:
      - command: root
#        name: basic_linux_commands


- test:
    namespace: linux1
    timeout:
      minutes: 10
    interactive:
    - name: basic_linux_commands_emmcboot
      prompts: ["login:","Password:","# "]
      script:
      - command: root
#        name: basic_linux_commands

- test:
    namespace: linux1
    timeout:
      minutes: 10
    interactive:
    - name: basic_linux_commands_emmcboot
      prompts: ["login:","Password:","# "]
      script:
      - command: root
#        name: basic_linux_commands

- test:
    namespace: linux1
    timeout:
      minutes: 10
    interactive:
    - name: basic_linux_commands_emmcboot
      prompts: ["# "]
      script:
      - command: pwd;ls
#        name: basic_linux_commands



- test:
    namespace: linux1
    timeout:
      minutes: 60
    interactive:
    - name: eMMC_Boot
      prompts: ["# "]
      script:
      #- command: sleep 5;ip link set dev eth0 address 60:E6:F0:D5:9F:1C
      - command: sleep 5;export TFTP_SERVER_IP="TFTP_SERVER_IP_ADDRESS"
      - command: sleep 5;export TFTP_PKG_DIR="TFTP_PKG_DIR_PATH"
      - command: sleep 5;export PACKAGE_VARIANT_NAME="GNB"
      - command: sleep 5;export FIRMWARE_EVB_VER="V2"
      - command: sleep 5;export ETHERNET_PORT="eth0"
      - command: sleep 5; export FW_FLASH_REQ="y"
      - command: sleep 5;cd /opt/flasher/
      - command: sed -i "s|tftp -g -r|set -x;time tftp -g -r|g"  /opt/flasher/emmc_flasher.sh

- test:
    namespace: linux1
    timeout:
      minutes: 60
    interactive:
    - name: eMMC_Boot1
      prompts: ["Restarting system"]
      script:
      - command: echo "y" | sh -v emmc_flasher.sh;
        name: eMMC_Boot
        #successes:
        #- message: "Restarting system"
        #failures:
        #- message: "TIMEOUT"
        #  exception: InfrastructureError
        #  error: "emmc_flasher_script failed"


########
#Linux Boot after flash boot setup
########

- boot:
    namespace: linux1
    method: minimal
    auto_login:
      login_prompt: 'login:'
      username: root
#      password_prompt: "Password:"
#      password: "root"
    timeout:
     minutes: 20
    prompts:
    - 'Password:'
#    - '#'
    timeout:
      minutes: 20


- test:
    namespace: linux1
    timeout:
      minutes: 10
    interactive:
    - name: basic_linux_commands_emmcboot
      prompts: ["Password:","raptor2 login:","#"]
      echo: discard
      script:
      - command: root
#        name: basic_linux_commands


- test:
    namespace: linux1
    timeout:
      minutes: 4
    interactive:
    - name: basic_linux_commands
      prompts: ["# "]
      echo: discard
      script:
      #- command:
      - command: ls -ltr;pwd; df -h; ls -l /dev | grep -i mmc
#        name: lstest
        successes:
        - message: "total"
        failures:
        - message: "TIMEOUT"
#          exception: InfrastructureError
          error: "ls failed"


